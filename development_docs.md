# HappyGames 开发文档

## 1. 项目概览 (Project Overview)
HappyGames 是一个基于 Pi Network 生态的游戏平台，允许用户通过 Pi 币兑换“欢乐豆”参与游戏，并赚取佣金。项目采用现代化的 Web 技术栈，注重用户体验和视觉效果。

### 技术栈 (Tech Stack)
- **前端**: Next.js 14 (React), TailwindCSS, TypeScript
- **后端**: Node.js, Express, Socket.io, MongoDB
- **国际化**: 自研 React Context i18n 方案 (支持 14 种语言)

---

## 2. 项目风格与设计 (Project Style & Design)

### 视觉主题 (Visual Theme)
项目采用 **“活力橙黄” (Vibrant Amber/Yellow)** 为主色调，营造轻松、快乐的游戏氛围。

- **背景**: 全局使用亮黄色渐变背景，从淡黄 (`#FFF176`) 过渡到橙黄 (`#FFA726`)，方向为 135 度。
- **质感**: 大量使用 **Glassmorphism (毛玻璃)** 效果。
    - 容器背景: `bg-white/90` (90% 不透明度白色)
    - 模糊效果: `backdrop-blur-sm`
    - 边框: `border-white/50` (半透明白色边框)
    - 阴影: `shadow-xl` 或 `shadow-2xl`
- **圆角**: 统一使用大圆角 (`rounded-2xl`, `rounded-xl`)，增强亲和力。
- **字体颜色**:
    - 主标题/强调文字: `text-amber-900` (深琥珀色)
    - 次要文字: `text-gray-600`
    - 成功/收益: `text-green-600`
    - 支出/警告: `text-red-600`

---

## 3. 页面布局与设置 (Page Layouts)

### 3.1 首页 (Home Page)
- **布局**: 居中布局，全屏显示。
- **顶部导航 (Header)**:
    - 左侧: 品牌名称 "HappyGames"
    - 右侧: 语言切换器 (Language Switcher) + 用户头像/用户名 (登录后)
- **核心区域 (Hero Section)**:
    - **大标题**: "HappyGames" (Games 字样使用琥珀色高亮)
    - **副标题**: 多语言支持的欢迎语。
    - **登录卡片 (Login Card)**:
        - 仅在未登录时显示。
        - 包含 "Login with Pi" 按钮，点击触发 Pi SDK 认证。
        - 底部显示隐私协议提示。
    - **进入大厅按钮**: 登录后显示，绿色渐变按钮，引导用户进入游戏大厅。
- **装饰元素**: 背景中有动态漂浮的模糊光斑，增加页面层次感。

### 3.2 个人中心 (User Profile)
- **布局**: 响应式布局。移动端为单列，桌面端为双列。
- **头部信息栏 (Profile Header)**:
    - 左侧: 用户大头像 (带琥珀色光晕) + 用户名 + 徽章 (等级/推广员) + ID 显示。
    - 右侧: 语言切换器 + 退出登录按钮 (红色幽灵按钮)。
- **内容区域**:
    - **左列**: **资产中心 (Asset Center)** - *核心功能区*
    - **右列**: **推广数据 (Referral Stats)**
        - 显示已邀请人数。
        - 显示总流水 (Total Flow)。
        - 显示专属推广链接 (可复制)。

---

## 4. 资产中心详细布局 (Asset Center Layout)
位于 `WalletExchange.tsx` 组件中，是用户进行充值和提现的核心面板。

### 4.1 顶部概览
- **标题**: "💰 资产中心" (带图标)。
- **余额卡片**: 并排展示两个卡片。
    - **欢乐豆 (HAPPY BEANS)**: 橙色背景 (`bg-orange-50`)，显示当前游戏货币余额。
    - **佣金 (COMMISSION)**: 紫色背景 (`bg-purple-50`)，显示推广赚取的佣金余额。
- **提示栏**: 蓝色背景 (`bg-blue-50`) 的信息框，说明支持灵活转账。

### 4.2 操作选项卡 (Tabs)
- 使用 `bg-gray-100` 的胶囊式切换器。
- **充值 (Deposit)**: 选中时白色背景，琥珀色文字。
- **提现 (Withdraw)**: 选中时白色背景，琥珀色文字。

### 4.3 充值面板 (Deposit Panel)
设计为“扫码/转账 -> 确认”的流程。
1.  **标题**: "您的专属充值地址"。
2.  **二维码区域**: 居中显示的二维码占位符 (白色方块，虚线边框)。
3.  **地址显示**: 
    - 样式: `font-mono` (等宽字体)，加粗，方便阅读。
    - 背景: 白色背景，独立边框。
4.  **免备注提示**: 绿色胶囊标签，强调 "无需备注 (No Memo Required)"。
5.  **操作步骤**: 简明的两步指引 (Step 1 转账, Step 2 确认)。
6.  **确认按钮**: 
    - 文字: "我已转账 (检查充值)"
    - 样式: 橙色渐变 (`from-amber-500 to-orange-600`)，全宽大按钮。
    - 交互: 点击后触发后端查询，模拟区块链扫描延迟。
7.  **充值成功弹窗 (Success Modal)**:
    - 替代原生的 `alert` 弹窗。
    - **UI**: 白色圆角卡片，绿色成功图标，显示充值金额和 Order ID。
    - **交互**: 点击 "Great!" 按钮关闭弹窗。

### 4.4 提现面板 (Withdraw Panel)
表单式布局。
1.  **提现地址输入框**:
    - 标签: "提现地址" (大写，灰色)。
    - 输入框: 大圆角，白色背景，输入 Pi 钱包地址 (G-...)。
2.  **数量输入框**:
    - 标签: "数量 (欢乐豆)"。
    - 输入框: 数字输入。
3.  **提现按钮**:
    - 文字: "提现"
    - 样式: 同充值按钮，橙色渐变。
    - 逻辑: 检查余额 -> 扣除欢乐豆 -> 模拟发送 Pi -> 生成交易记录。

### 4.5 交易记录 (Transaction History)
- **标题**: "交易记录" (大写，灰色小字)。
- **列表**: 滚动列表 (`max-h-60 overflow-y-auto`)。
- **单条记录**:
    - 左侧: 类型 (充值/提现) + 日期。
    - 右侧: 
        - 欢乐豆变动 (充值绿色 `+`, 提现红色 `-`)。
        - 估算 Pi 价值 (灰色小字)。

---

## 5. 国际化支持 (Internationalization)
- **支持语言**: 14 种 (英语, 中文, 日语, 韩语, 俄语, 德语, 法语, 阿拉伯语, 越南语, 西班牙语, 葡萄牙语, 繁体中文, 马来语, 希伯来语)。
- **实现方式**: 
    - `LanguageContext`: 全局管理当前语言状态，持久化到 `localStorage`。
    - `translations` 对象: 包含所有文本的键值对字典。
    - 动态替换: 页面所有文本均通过 `t.key` 方式获取，确保切换语言时无缝更新。

---

## 6. 用户资料增强 (User Profile Enhancements)

### 6.1 昵称系统 (Nickname System)
- **显示逻辑**: 优先显示用户设置的昵称 (`nickname`)，若未设置则回退显示用户名 (`username`)。
- **修改功能**:
    - **入口**: 个人中心用户名旁的“编辑”图标 (✏️)。
    - **交互**: 点击图标弹出自定义模态框 (Modal)。
    - **模态框设计**:
        - 风格与全局一致 (白色圆角卡片，阴影，磨砂背景遮罩)。
        - 包含输入框和“取消/保存”按钮。
    - **验证逻辑**:
        - **唯一性检查**: 后端 API (`/api/users/update`) 在更新前会查询数据库，确保昵称全平台唯一。
        - **错误处理**: 若昵称已存在，返回 400 错误，前端弹出 Alert 提示 "Nickname already taken"。

---

## 7. 游戏逻辑与经济模型 (Game Logic & Economics)

### 7.1 游戏结算服务 (Game Settlement Service)
由 `GameService.js` 统一处理游戏结束后的资金流转。

1.  **下注扣除**:
    - 游戏开始或结算时，直接从玩家钱包 (`Wallet`) 中扣除下注金额 (`happyBeans`)。
    - 生成类型为 `BET` 的交易记录。

2.  **平台服务费 (Platform Fee)**:
    - **费率**: 固定为 **5%** (`PLATFORM_FEE_RATE = 0.05`)。
    - **计算方式**: `总服务费 = 总下注池 (Total Pot) * 0.05`。
    - **单人贡献记录**: 系统会记录每位玩家在该局游戏中实际贡献的服务费金额 (`玩家下注额 * 0.05`)，用于后续佣金计算。

3.  **奖金分配**:
    - `净奖池 (Net Pot) = 总下注池 - 总服务费`。
    - 净奖池平分给所有赢家。
    - 生成类型为 `WIN` 的交易记录。

### 7.2 佣金机制 (Commission Mechanism)
采用 **“单人贡献制”**，确保佣金计算精确且公平。

- **核心原则**: 推广员获得的佣金，直接来源于其下线玩家在游戏中**实际贡献的平台服务费**。
- **计算公式**:
    > `佣金 = 下线玩家贡献的服务费 * 推广员等级对应比例`
- **等级比例**:
    - Lv1: 10%
    - Lv2: 15%
    - Lv3: 20%
    - Lv4: 25%
    - Lv5: 30%
- **示例**:
    - 玩家 A (下线) 下注 1000 豆。
    - 贡献服务费 = 1000 * 5% = 50 豆。
    - 推广员 B (Lv2, 15%) 获得佣金 = 50 * 15% = 7.5 豆。

### 7.3 流水与升级 (Flow & Level Up)
- **流水定义**: 玩家的**下注金额**计入其上级推广员的“总流水”。
- **实时更新**: 每次游戏结算时，自动累加流水到推广员的 `referralStats.totalFlow`。
- **自动升级**: 系统根据最新的邀请人数和总流水，自动判断并提升推广员等级。

---

## 8. 游戏大厅 (Game Lobby)
位于 `GameList.tsx`，是玩家进入游戏的入口。

### 8.1 界面设计
- **风格**: 延续全局的 "Glassmorphism" + "Vibrant Amber" 风格。
- **数据看板**:
    - **在线玩家 (Online Players)**: 蓝色卡片，实时显示当前在线人数。
    - **生态池 (Eco Pool)**: 绿色卡片，显示当前生态池的 Pi 储备量。
- **游戏列表**:
    - 采用卡片式设计，展示游戏名称、图标、最低准入金额。
    - "Happy Poker" 带有 "HOT" 标签。

### 8.2 匹配功能
- **快速匹配 (Quick Match)**:
    - 按钮带有加载状态 (Loading Spinner)。
    - 点击后触发 socket `start_matchmaking` 事件。
    - 匹配成功后弹出提示并跳转 (目前为 Alert)。

### 8.3 大厅动态 (Lobby Feed)
替代原有的匹配设置面板，展示大厅内的实时动态，增加活跃氛围。
- **展示内容**:
    - 用户进入大厅 (Join)。
    - 用户赢得游戏 (Win)。
    - 用户中大奖 (Jackpot)。
- **UI**: 列表式展示，不同类型的事件带有不同的图标和颜色背景。

### 8.4 国际化新增键值

### 8.3 国际化新增键值
- `lobby_title`: 游戏大厅
- `online_players`: 在线玩家
- `eco_pool`: 生态池
- `quick_match`: 快速匹配
- `game_poker`: 欢乐扑克
- `start_matching`: 开始匹配
- `lobby_feed`: 大厅动态
- `recent_activity`: 最新动态

