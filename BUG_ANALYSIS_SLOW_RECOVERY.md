# é—®é¢˜åˆ†æï¼šæ¸¸æˆç»“æŸåçŠ¶æ€æ¢å¤æ…¢\n\n## é—®é¢˜ç°è±¡\n\nä¸€æ–¹æˆ–åŒæ–¹é€€å‡ºæ¸¸æˆåï¼Œæ¸¸æˆæ¡Œçš„çŠ¶æ€æ¢å¤å¾ˆæ…¢ï¼Œå¾ˆä¹…æ‰æ¢å¤åˆ°ç©ºé—²çŠ¶æ€ï¼ˆIDLEï¼‰ã€‚\n\n## æ ¹æœ¬åŸå› \n\n### æ‰§è¡Œæµç¨‹åˆ†æ\n\n```\næ—¶é—´   äº‹ä»¶                    çŠ¶æ€å˜åŒ–                    å¤‡æ³¨\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nt0     æ¸¸æˆç»“æŸ\n       Aæˆ–Bç‚¹å‡»\"é€€å‡ºæ¸¸æˆ\"\n       â†“\n       playerLeave()\n       â†“\n       onGameEnd()\n         â”œâ”€ status = MATCHING âœ“\n         â”œâ”€ broadcastRoomState()\n         â””â”€ startRematchCountdown()  â† å¯åŠ¨10ç§’å€’è®¡æ—¶ï¼\n\nt1-t10 æˆ¿é—´çŠ¶æ€: MATCHING\n       ç­‰å¾…å†æ¥ä¸€å±€å€’è®¡æ—¶...\n       ç”¨æˆ·å·²å…¨éƒ¨ç¦»å¼€ï¼Œä½†è®¡æ—¶å™¨ä»åœ¨è¿è¡Œ\n       \nt10    onRematchTimeout() è§¦å‘\n       â†“\n       â”œâ”€ æ£€æŸ¥è¿˜æœ‰æ²¡æœ‰ç©å®¶\n       â”œâ”€ å¦‚æœæœ‰ç©å®¶: status = WAITING\n       â”œâ”€ å¦‚æœæ— ç©å®¶: reset() â†’ status = IDLE âœ“\n       â””â”€ å¹¿æ’­æˆ¿é—´çŠ¶æ€\n\né—®é¢˜ï¼š\n- æ¸¸æˆç»“æŸæ—¶å¯åŠ¨äº†10ç§’å†æ¥ä¸€å±€å€’è®¡æ—¶\n- å³ä½¿æ‰€æœ‰ç©å®¶éƒ½é€€å‡ºï¼Œå€’è®¡æ—¶ä»åœ¨è¿è¡Œ\n- 10ç§’åæ‰ä¼šæ£€æŸ¥ç©å®¶æ•°ï¼Œæ‰ä¼šé‡ç½®ä¸ºIDLE\n```\n\n## ä»£ç ä¸­çš„é—®é¢˜\n\n### é—®é¢˜1ï¼šonGameEnd() æ— æ¡ä»¶å¯åŠ¨å†æ¥ä¸€å±€å€’è®¡æ—¶\n\n**ä½ç½®**: `MatchPlayers.js` ç¬¬1822è¡Œ\n\n```javascript\nonGameEnd(result) {\n    // ...\n    this.startRematchCountdown();  // â† æ— è®ºå¦‚ä½•éƒ½å¯åŠ¨10ç§’å€’è®¡æ—¶\n}\n```\n\n**é—®é¢˜**ï¼š\n- æ¸¸æˆç»“æŸåç«‹å³å¯åŠ¨10ç§’çš„å†æ¥ä¸€å±€å€’è®¡æ—¶\n- è¿™ä¸ªå€’è®¡æ—¶ä¸ç©å®¶æ˜¯å¦ç•™åœ¨æˆ¿é—´æ— å…³\n- å³ä½¿æ‰€æœ‰ç©å®¶éƒ½ç¦»å¼€äº†ï¼Œå€’è®¡æ—¶ä»åœ¨è¿è¡Œ\n\n### é—®é¢˜2ï¼šplayerLeave() æ²¡æœ‰æ£€æŸ¥æ˜¯å¦éœ€è¦ç«‹å³é‡ç½®\n\n**ä½ç½®**: `MatchPlayers.js` ç¬¬1421-1487è¡Œ\n\n```javascript\n_playerLeave(socket) {\n    // ... ç§»é™¤ç©å®¶ ...\n    \n    if (this.matchState.players.length === 0) {\n        this.matchState.status = MatchingRules.TABLE_STATUS.IDLE;  // â† åªæ˜¯æ”¹çŠ¶æ€\n        // ... æ¸…ç† ...\n    }\n    \n    this.table.broadcastRoomState();  // â† å¹¿æ’­çŠ¶æ€ä¸ºIDLE\n    // ä½†å†æ¥ä¸€å±€å€’è®¡æ—¶ä»åœ¨è¿è¡Œï¼\n}\n```\n\n**é—®é¢˜**ï¼š\n- å½“æ‰€æœ‰ç©å®¶éƒ½ç¦»å¼€æ—¶ï¼Œåªæ˜¯å°†çŠ¶æ€æ”¹ä¸ºIDLE\n- æ²¡æœ‰ç«‹å³æ¸…é™¤æ­£åœ¨è¿è¡Œçš„å†æ¥ä¸€å±€å€’è®¡æ—¶\n- è¿™æ„å‘³ç€çŠ¶æ€è™½ç„¶å˜ä¸ºIDLEï¼Œä½†æˆ¿é—´çš„å®šæ—¶å™¨ä»åœ¨è®¡æ—¶\n\n### é—®é¢˜3ï¼šreset() ä¸ä¼šæ¸…é™¤å†æ¥ä¸€å±€å€’è®¡æ—¶\n\n**ä½ç½®**: `MatchPlayers.js` ç¬¬1908-1920è¡Œ\n\n```javascript\nreset() {\n    this.matchState.resetReadyStatus();\n    this.matchState.status = MatchingRules.TABLE_STATUS.IDLE;\n    this.matchState.rematchRequests.clear();\n    \n    this.table.broadcastRoomState();\n    \n    this.startZombieCheck();  // â† å¯åŠ¨æ–°çš„åƒµå°¸æ¡Œæ£€æŸ¥\n    // æ²¡æœ‰æ¸…é™¤ rematchTimerï¼\n}\n```\n\n**é—®é¢˜**ï¼š\n- `reset()` ä¼šæ¸…é™¤å‡†å¤‡è¶…æ—¶å€’è®¡æ—¶ã€å¥½å‹å€’è®¡æ—¶ç­‰\n- ä½†æ²¡æœ‰æ¸…é™¤å†æ¥ä¸€å±€å€’è®¡æ—¶\n- è¿™å¯¼è‡´å†æ¥ä¸€å±€å€’è®¡æ—¶ä¼šç»§ç»­è¿è¡Œ10ç§’\n\n## æ—¶é—´çº¿\n\n```\nç”¨æˆ·æ“ä½œæ—¶é—´åºåˆ—\n\nt=0s\n  Aå’ŒBéƒ½åœ¨ç©æ¸¸æˆ (status: PLAYING)\n  \nt=5s\n  Aç‚¹å‡»\"é€€å‡ºæ¸¸æˆ\"\n  â”œâ”€ handleWin('b')\n  â”œâ”€ onGameEnd()\n  â”‚  â”œâ”€ status = MATCHING\n  â”‚  â”œâ”€ broadcastRoomState()  â†’ {status: MATCHING, players: 2}\n  â”‚  â””â”€ startRematchCountdown()  â†’ å¯åŠ¨10ç§’å€’è®¡æ—¶ â±ï¸\n  â”œâ”€ playerLeave()\n  â”‚  â”œâ”€ removePlayer(A)\n  â”‚  â”œâ”€ players: 2 â†’ 1\n  â”‚  â””â”€ broadcastRoomState()  â†’ {status: MATCHING, players: 1}\n\nt=6s\n  Bä¹Ÿç‚¹å‡»\"é€€å‡ºæ¸¸æˆ\"\n  â”œâ”€ playerLeave()\n  â”‚  â”œâ”€ removePlayer(B)\n  â”‚  â”œâ”€ players: 1 â†’ 0\n  â”‚  â”œâ”€ status = IDLE  âœ“\n  â”‚  â””â”€ broadcastRoomState()  â†’ {status: IDLE, players: 0}\n  \n  ğŸ”´ é—®é¢˜ï¼š\n  - è™½ç„¶å¹¿æ’­äº† IDLE çŠ¶æ€\n  - ä½†å†æ¥ä¸€å±€å€’è®¡æ—¶ä»åœ¨è¿è¡Œ\n  - è¿˜éœ€è¦å†ç­‰ 4 ç§’æ‰ä¼šè§¦å‘ onRematchTimeout()\n  - å³ä½¿è§¦å‘åï¼Œä¹Ÿä¸ä¼šå†æ”¹å˜çŠ¶æ€ï¼ˆå·²ç»æ˜¯IDLEäº†ï¼‰\n  - æ‰€ä»¥çœ‹èµ·æ¥åƒæ˜¯\"å¾ˆä¹…æ‰æ¢å¤\"ï¼Œå®é™…æ˜¯10ç§’å€’è®¡æ—¶å®Œæˆ\n\nt=15s\n  å†æ¥ä¸€å±€å€’è®¡æ—¶åˆ°æœŸ\n  â”œâ”€ onRematchTimeout()\n  â”œâ”€ æ£€æŸ¥ç©å®¶: players.length = 0\n  â”œâ”€ è°ƒç”¨ reset()\n  â”‚  â”œâ”€ status = IDLEï¼ˆé‡å¤è®¾ç½®ï¼‰\n  â”‚  â”œâ”€ broadcastRoomState()ï¼ˆä¸å¿…è¦çš„é‡å¤å¹¿æ’­ï¼‰\n  â”‚  â””â”€ startZombieCheck()ï¼ˆæ–°çš„åƒµå°¸æ¡Œæ£€æŸ¥ï¼‰\n  â””â”€ å®Œæˆ âœ“\n```\n\n## é—®é¢˜çš„è¡¨ç°\n\n**ç”¨æˆ·è§‚å¯Ÿåˆ°çš„ç°è±¡**ï¼š\n- Aå’ŒBéƒ½ç¦»å¼€äº†æˆ¿é—´\n- ä½†æˆ¿é—´çŠ¶æ€ä»æ˜¾ç¤ºä¸ºæŸä¸ªä¸­é—´çŠ¶æ€\n- è¿‡äº†ä¸€æ®µæ—¶é—´ï¼ˆçº¦10ç§’ï¼‰æ‰å˜ä¸ºç©ºé—²çŠ¶æ€\n\n**å®é™…å‘ç”Ÿçš„äº‹**ï¼š\n- ç©å®¶ç¦»å¼€æ—¶ï¼Œç¡®å®ç«‹å³æ”¹ä¸ºIDLEçŠ¶æ€\n- ä½†å†æ¥ä¸€å±€å€’è®¡æ—¶ï¼ˆ10ç§’ï¼‰ä»åœ¨åå°è¿è¡Œ\n- å€’è®¡æ—¶å®Œæˆåï¼Œä¼šé‡å¤åœ°è®¾ç½®IDLEçŠ¶æ€å’Œå¹¿æ’­\n\n## è§£å†³æ–¹æ¡ˆ\n\n### æ–¹æ¡ˆ1ï¼šåœ¨playerLeave()ä¸­æ¸…é™¤å†æ¥ä¸€å±€å€’è®¡æ—¶ï¼ˆæ¨èï¼‰\n\n**æ”¹åŠ¨ä½ç½®**: `MatchPlayers.js` ç¬¬1487è¡Œé™„è¿‘\n\n```javascript\n_playerLeave(socket) {\n    // ... ç§»é™¤ç©å®¶ ...\n    \n    if (wasPlayer || wasSpectator) {\n        socket.leave(this.roomId);\n        \n        // å¦‚æœæ‰€æœ‰ç©å®¶éƒ½ç¦»åº§äº†ï¼Œç«‹å³æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨\n        if (this.matchState.players.length === 0) {\n            console.log(`[MatchPlayers] All players left the table, cleaning up timers`);\n            \n            // ğŸ”§ æ¸…é™¤å†æ¥ä¸€å±€å€’è®¡æ—¶\n            if (this.matchState.rematchTimer) {\n                clearTimeout(this.matchState.rematchTimer);\n                this.matchState.rematchTimer = null;\n            }\n            \n            // æ¸…é™¤å…¶ä»–å®šæ—¶å™¨\n            this.matchState.status = MatchingRules.TABLE_STATUS.IDLE;\n            this.matchState.resetReadyStatus();\n            this.readyCheckCancelled = false;\n            this.isLocked = false;\n        }\n        \n        this.table.broadcastRoomState();\n        // ... å…¶ä»–é€»è¾‘ ...\n    }\n}\n```\n\n**ä¼˜ç‚¹**ï¼š\n- ç«‹å³æ¸…é™¤å€’è®¡æ—¶ï¼ŒçŠ¶æ€æ¢å¤å¿«é€Ÿ\n- ä¸éœ€è¦ç­‰å¾…10ç§’\n- é€»è¾‘æ¸…æ™°ï¼šäººèµ°äº†ï¼Œå€’è®¡æ—¶å°±åœ\n\n### æ–¹æ¡ˆ2ï¼šåœ¨reset()ä¸­æ¸…é™¤å†æ¥ä¸€å±€å€’è®¡æ—¶\n\n**æ”¹åŠ¨ä½ç½®**: `MatchPlayers.js` ç¬¬1910è¡Œ\n\n```javascript\nreset() {\n    this.matchState.resetReadyStatus();\n    this.matchState.status = MatchingRules.TABLE_STATUS.IDLE;\n    this.matchState.rematchRequests.clear();\n    \n    // ğŸ”§ æ¸…é™¤æ‰€æœ‰æ´»åŠ¨çš„å®šæ—¶å™¨\n    if (this.matchState.rematchTimer) {\n        clearTimeout(this.matchState.rematchTimer);\n        this.matchState.rematchTimer = null;\n        console.log(`[MatchPlayers] Cleared rematch timer in reset()`);\n    }\n    \n    this.table.broadcastRoomState();\n    this.startZombieCheck();\n}\n```\n\n**ä¼˜ç‚¹**ï¼š\n- ç¡®ä¿reset()çœŸæ­£é‡ç½®æ‰€æœ‰çŠ¶æ€\n- é˜²æ­¢å€’è®¡æ—¶çš„åç»­è§¦å‘\n\n### æ–¹æ¡ˆ3ï¼šåœ¨onGameEnd()ä¸­æ£€æŸ¥ç©å®¶æ•°\n\n**æ”¹åŠ¨ä½ç½®**: `MatchPlayers.js` ç¬¬1792è¡Œ\n\n```javascript\nonGameEnd(result) {\n    // ...\n    \n    // ğŸ”§ åªåœ¨è¿˜æœ‰ç©å®¶æ—¶æ‰å¯åŠ¨å†æ¥ä¸€å±€å€’è®¡æ—¶\n    if (this.matchState.players.length > 0) {\n        this.startRematchCountdown();\n    } else {\n        // æ‰€æœ‰ç©å®¶éƒ½ç¦»å¼€äº†ï¼Œç›´æ¥é‡ç½®\n        console.log(`[MatchPlayers] No players left, skipping rematch countdown`);\n        this.reset();\n    }\n}\n```\n\n**ä¼˜ç‚¹**ï¼š\n- é˜²æ­¢ä¸å¿…è¦çš„å€’è®¡æ—¶å¯åŠ¨\n- ä½†é—®é¢˜æ˜¯onGameEnd()æ—¶ï¼Œç©å®¶å¯èƒ½è¿˜åœ¨æˆ¿é—´é‡Œ\n\n## æ¨èçš„ä¿®å¤\n\n**ä½¿ç”¨æ–¹æ¡ˆ1 + æ–¹æ¡ˆ2çš„ç»„åˆ**ï¼ˆæœ€å½»åº•ï¼‰\n\n```javascript\n// åœ¨ _playerLeave() ä¸­ï¼ˆæ–¹æ¡ˆ1ï¼‰\nif (this.matchState.players.length === 0) {\n    // æ¸…é™¤å†æ¥ä¸€å±€å€’è®¡æ—¶\n    if (this.matchState.rematchTimer) {\n        clearTimeout(this.matchState.rematchTimer);\n        this.matchState.rematchTimer = null;\n    }\n    // ... å…¶ä»–åˆå§‹åŒ– ...\n}\n\n// åœ¨ reset() ä¸­ï¼ˆæ–¹æ¡ˆ2ï¼‰\nif (this.matchState.rematchTimer) {\n    clearTimeout(this.matchState.rematchTimer);\n    this.matchState.rematchTimer = null;\n}\n```\n\n**å¥½å¤„**ï¼š\n- åŒé‡ä¿é™©ï¼šplayerLeave()å¿«é€Ÿæ¸…ç† + reset()å®Œæ•´æ¸…ç†\n- æ— è®ºå“ªä¸ªè·¯å¾„ï¼Œéƒ½èƒ½ç¡®ä¿å€’è®¡æ—¶è¢«æ¸…é™¤\n- çŠ¶æ€æ¢å¤ç«‹å³å®Œæˆï¼Œä¸éœ€è¦ç­‰å¾…\n\n## éªŒè¯\n\n### ä¿®å¤å‰\n```\nt=0s: A Bå¼€å§‹æ¸¸æˆ\nt=5s: Aé€€å‡º â†’ status=MATCHING, ç»§ç»­è®¡æ—¶...\nt=6s: Bé€€å‡º â†’ status=IDLE, ä½†å€’è®¡æ—¶æœªåœæ­¢\nt=7-14s: æˆ¿é—´çŠ¶æ€è™½ç„¶æ˜¯IDLEï¼Œä½†å®šæ—¶å™¨ä»åœ¨è¿è¡Œ\nt=15s: onRematchTimeout()è§¦å‘ â†’ é‡å¤è®¾ç½®IDLE\n\nç°è±¡ï¼š\"å¾ˆä¹…æ‰å®Œå…¨æ¢å¤\" (10ç§’)\n```\n\n### ä¿®å¤å\n```\nt=0s: A Bå¼€å§‹æ¸¸æˆ\nt=5s: Aé€€å‡º â†’ status=MATCHING, players=1\nt=6s: Bé€€å‡º â†’ status=IDLE, æ¸…é™¤å€’è®¡æ—¶ âœ“\nt=6.1s: å®šæ—¶å™¨å·²æ¸…é™¤ï¼Œä¸éœ€è¦å†ç­‰\n\nç°è±¡ï¼š\"ç«‹å³æ¢å¤åˆ°IDLE\" âœ“\n```\n\n## å½±å“åˆ†æ\n\n**ä¿®å¤å‰çš„é—®é¢˜**ï¼š\n- âŒ ç”¨æˆ·ç­‰å¾…10ç§’æ‰çœ‹åˆ°æˆ¿é—´æ¢å¤\n- âŒ ä¸å¿…è¦çš„èµ„æºæµªè´¹ï¼ˆå®šæ—¶å™¨åœ¨åå°è¿è¡Œï¼‰\n- âŒ ä¸å¿…è¦çš„é‡å¤å¹¿æ’­ï¼ˆonRematchTimeout()ä¼šå†å¹¿æ’­ä¸€æ¬¡ï¼‰\n\n**ä¿®å¤åçš„æ”¹è¿›**ï¼š\n- âœ… ç«‹å³æ¢å¤ï¼ˆç§’çº§å“åº”ï¼‰\n- âœ… åŠæ—¶é‡Šæ”¾èµ„æº\n- âœ… é¿å…é‡å¤æ“ä½œ\n\n## ç›¸å…³ä»£ç ä½ç½®\n\n```\nserver/src/gamecore/matching/MatchPlayers.js\n  â”œâ”€ ç¬¬1421-1487è¡Œ: _playerLeave() æ–¹æ³• â† æ·»åŠ å€’è®¡æ—¶æ¸…ç†\n  â”œâ”€ ç¬¬1792è¡Œ: onGameEnd() æ–¹æ³•\n  â”œâ”€ ç¬¬1908-1920è¡Œ: reset() æ–¹æ³• â† æ·»åŠ å€’è®¡æ—¶æ¸…ç†\n  â”œâ”€ ç¬¬1829-1836è¡Œ: startRematchCountdown() æ–¹æ³•\n  â””â”€ ç¬¬1860-1896è¡Œ: onRematchTimeout() æ–¹æ³•\n```\n\n## æ€»ç»“\n\n**é—®é¢˜**ï¼šæ¸¸æˆç»“æŸåï¼Œå³ä½¿æ‰€æœ‰ç©å®¶éƒ½ç¦»å¼€ï¼Œæˆ¿é—´çš„å†æ¥ä¸€å±€å€’è®¡æ—¶ï¼ˆ10ç§’ï¼‰ä»åœ¨è¿è¡Œï¼Œå¯¼è‡´çŠ¶æ€æ¢å¤å¾ˆæ…¢ã€‚\n\n**æ ¹æœ¬åŸå› **ï¼šplayerLeave()å’Œreset()éƒ½æ²¡æœ‰æ¸…é™¤æ­£åœ¨è¿è¡Œçš„å†æ¥ä¸€å±€å€’è®¡æ—¶ã€‚\n\n**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨playerLeave()å’Œreset()ä¸­æ·»åŠ å€’è®¡æ—¶æ¸…ç†é€»è¾‘ã€‚\n\n**é¢„æœŸæ•ˆæœ**ï¼šç©å®¶ç¦»å¼€æˆ¿é—´åï¼Œæˆ¿é—´çŠ¶æ€ç«‹å³æ¢å¤åˆ°IDLEï¼Œä¸éœ€è¦ç­‰å¾…ã€‚\n"