# ğŸ¯ æ¸¸æˆåŒ¹é…ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
3. [æœåŠ¡ç«¯é›†æˆ](#æœåŠ¡ç«¯é›†æˆ)
4. [å®¢æˆ·ç«¯é›†æˆ](#å®¢æˆ·ç«¯é›†æˆ)
5. [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
6. [äº‹ä»¶æµç¨‹](#äº‹ä»¶æµç¨‹)

---

## æ¦‚è¿°

åŒ¹é…ç³»ç»Ÿæä¾›äº†ä¸¤ç§ç©å®¶åŒ¹é…æ–¹å¼ï¼š
1. **è‡ªåŠ¨åŒ¹é…**ï¼šæ ¹æ®ç©å®¶è®¾ç½®çš„æ¡ä»¶è‡ªåŠ¨åŒ¹é…åˆé€‚çš„å¯¹æ‰‹
2. **æ‰‹åŠ¨å…¥åº§**ï¼šç©å®¶ä¸»åŠ¨é€‰æ‹©æ¸¸æˆæ¡Œå…¥åº§

### æ ¸å¿ƒç‰¹æ€§

- âœ… **åŒ¹é…æ¡ä»¶è®¾ç½®**ï¼šåº•è±†ã€èƒœç‡ã€æ‰çº¿ç‡
- âœ… **è‡ªåŠ¨åŒ¹é…é˜Ÿåˆ—**ï¼šæ™ºèƒ½åŒ¹é…ç®—æ³•
- âœ… **å‡†å¤‡/å¼€å§‹æœºåˆ¶**ï¼š30ç§’å€’è®¡æ—¶
- âœ… **åƒµå°¸æ¡Œæ¸…ç†**ï¼š5åˆ†é’Ÿæ— åŒ¹é…è‡ªåŠ¨æ¸…ç†
- âœ… **æ—è§‚åŠŸèƒ½**ï¼šä»…æ˜¾ç¤ºå…¬å…±ä¿¡æ¯
- âœ… **å†æ¥ä¸€å±€**ï¼šæ¸¸æˆç»“æŸåå¿«é€Ÿå¼€å§‹æ–°å±€

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. åŒ¹é…æ¡ä»¶

ç©å®¶å¯ä»¥è®¾ç½®ä»¥ä¸‹åŒ¹é…æ¡ä»¶ï¼š

| æ¡ä»¶ | é»˜è®¤å€¼ | èŒƒå›´ | è¯´æ˜ |
|------|--------|------|------|
| **æ¸¸æˆåº•è±†** | 1000 | 100-100,000 | æœ¬å±€æ¸¸æˆçš„åº•è±†æ•°é‡ |
| **åº•è±†èŒƒå›´** | 500-5000 | 100-100,000 | å¯æ¥å—çš„å¯¹æ‰‹åº•è±†èŒƒå›´ |
| **èƒœç‡èŒƒå›´** | 0-100% | 0-100% | å¯æ¥å—çš„å¯¹æ‰‹èƒœç‡èŒƒå›´ |
| **æœ€å¤§æ‰çº¿ç‡** | 100% | 0-100% | å¯¹æ‰‹çš„æœ€å¤§æ‰çº¿ç‡ |
| **ç­‰çº§åˆ†èŒƒå›´** â­ | æ— é™åˆ¶ | 0-3000 | å¯¹æ‰‹çš„ç­‰çº§åˆ†èŒƒå›´ï¼ˆå¯é€‰ï¼‰ |

#### â­ é‡è¦è¯´æ˜ï¼šåŒ¹é…æ¡ä»¶çš„ä½œç”¨èŒƒå›´

**åŒ¹é…æ¡ä»¶æ§åˆ¶çš„æ˜¯å•ä¸ªæ¸¸æˆæ¡Œï¼ˆGame Tableï¼‰ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ¸¸æˆå®¤ï¼ˆGame Roomï¼‰**ï¼š

- âœ… æ¯ä¸ªæ¸¸æˆæ¡Œéƒ½æœ‰ç‹¬ç«‹çš„åŒ¹é…æ¡ä»¶
- âœ… ç¬¬ä¸€ä¸ªå…¥åº§çš„ç©å®¶è®¾ç½®è¯¥æ¡Œçš„åŒ¹é…æ ‡å‡†
- âœ… åç»­ç©å®¶å¿…é¡»ç¬¦åˆç¬¬ä¸€ä¸ªç©å®¶è®¾ç½®çš„æ¡ä»¶æ‰èƒ½å…¥åº§
- âœ… ä¸åŒæ¸¸æˆæ¡Œçš„åŒ¹é…æ¡ä»¶äº’ä¸å½±å“
- âœ… æ¸¸æˆæ¡Œæ¸…ç©ºåï¼ŒåŒ¹é…æ¡ä»¶é‡ç½®ä¸ºé»˜è®¤å€¼

**ç¤ºä¾‹**ï¼š
```
æ¸¸æˆå®¤ï¼šåˆçº§å®¤ï¼ˆchinesechess_beginnerï¼‰

æ¸¸æˆæ¡Œ Aï¼ˆchinesechess_beginner_0ï¼‰ï¼š
  - ç¬¬ä¸€ä¸ªç©å®¶è®¾ç½®ï¼šèƒœç‡ 40-60%ï¼Œæ‰çº¿ç‡ â‰¤ 20%ï¼Œç­‰çº§åˆ† 1200-1800
  - åç»­ç©å®¶å¿…é¡»ç¬¦åˆè¿™äº›æ¡ä»¶æ‰èƒ½å…¥åº§

æ¸¸æˆæ¡Œ Bï¼ˆchinesechess_beginner_1ï¼‰ï¼š
  - ç¬¬ä¸€ä¸ªç©å®¶è®¾ç½®ï¼šèƒœç‡ 60-80%ï¼Œæ‰çº¿ç‡ â‰¤ 10%ï¼Œç­‰çº§åˆ† 1500-2000
  - åç»­ç©å®¶å¿…é¡»ç¬¦åˆè¿™äº›æ¡ä»¶æ‰èƒ½å…¥åº§

ä¸¤ä¸ªæ¡Œå­çš„æ¡ä»¶å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ï¼
```

### 2. è‡ªåŠ¨åŒ¹é…æµç¨‹

```
1. ç©å®¶è®¾ç½®åŒ¹é…æ¡ä»¶
   â†“
2. åŠ å…¥åŒ¹é…é˜Ÿåˆ—
   â†“
3. ç³»ç»Ÿæ¯3ç§’æ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—
   â†“
4. æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å¯¹æ‰‹
   â†“
5. åˆ›å»ºæˆ¿é—´å¹¶é€šçŸ¥åŒæ–¹
   â†“
6. è¿›å…¥å‡†å¤‡é˜¶æ®µ
```

### 3. æ‰‹åŠ¨å…¥åº§æµç¨‹

```
1. ç©å®¶æŸ¥çœ‹æˆ¿é—´åˆ—è¡¨
   â†“
2. é€‰æ‹©åˆé€‚çš„æˆ¿é—´å…¥åº§
   â†“
3. ç­‰å¾…å…¶ä»–ç©å®¶å…¥åº§
   â†“
4. æ»¡åº§åè¿›å…¥å‡†å¤‡é˜¶æ®µï¼ˆ30ç§’å€’è®¡æ—¶ï¼‰
   â†“
5. æ‰€æœ‰ç©å®¶ç‚¹å‡»"å¼€å§‹"æˆ–å€’è®¡æ—¶ç»“æŸ
   â†“
6. æ¸¸æˆå¼€å§‹
```

### 4. å‡†å¤‡/å¼€å§‹æœºåˆ¶

- **è§¦å‘æ¡ä»¶**ï¼šæˆ¿é—´æ»¡åº§ï¼ˆè¾¾åˆ° `maxPlayers`ï¼‰
- **å€’è®¡æ—¶**ï¼š30ç§’
- **è§„åˆ™**ï¼š
  - æ‰€æœ‰ç©å®¶éƒ½ç‚¹å‡»"å¼€å§‹"ï¼šç«‹å³å¼€å§‹æ¸¸æˆ
  - å€’è®¡æ—¶ç»“æŸï¼šæœªç‚¹å‡»"å¼€å§‹"çš„ç©å®¶è¢«è¸¢å‡º
  - ä»»ä¸€ç©å®¶ç¦»åº§ï¼šå–æ¶ˆå€’è®¡æ—¶ï¼Œé‡æ–°ç­‰å¾…æ»¡åº§

### 5. åƒµå°¸æ¡Œæ¸…ç†

- **è§¦å‘æ¡ä»¶**ï¼šç¬¬ä¸€ä¸ªç©å®¶å…¥åº§å5åˆ†é’Ÿå†…æœªå¼€å§‹æ¸¸æˆ
- **æ¸…ç†åŠ¨ä½œ**ï¼šè¸¢å‡ºæ‰€æœ‰ç©å®¶ï¼Œé‡ç½®æˆ¿é—´çŠ¶æ€
- **é€šçŸ¥**ï¼šè¢«è¸¢ç©å®¶æ”¶åˆ° `kicked` äº‹ä»¶

### 6. æ—è§‚åŠŸèƒ½

- **é™åˆ¶**ï¼šä»…æ˜¾ç¤ºå…¬å…±æ¸¸æˆçŠ¶æ€ï¼ˆç‰Œæ¡Œå…¬å…±åŒºåŸŸï¼‰
- **éšè—**ï¼šç©å®¶æ‰‹ç‰Œç­‰ç§å¯†ä¿¡æ¯
- **ç›®çš„**ï¼šé˜²æ­¢"é€šç‰Œ"ä½œå¼Š

---

## æœåŠ¡ç«¯é›†æˆ

### 1. ä½¿ç”¨ MatchableGameRoom

```javascript
// server/src/games/mygame/rooms/MyGameRoom.js
const MatchableGameRoom = require('../../../gamecore/MatchableGameRoom');

class MyGameRoom extends MatchableGameRoom {
    constructor(roomId, io, tier) {
        // maxPlayers: æ¸¸æˆæ‰€éœ€ç©å®¶æ•°é‡ï¼ˆé‡è¦ï¼ï¼‰
        super(io, roomId, 2, tier); // 2äººæ¸¸æˆ
        
        this.gameType = 'mygame';
        
        // åˆå§‹åŒ–æ¸¸æˆç‰¹å®šçŠ¶æ€
        this.board = null;
        this.turn = null;
    }

    /**
     * æ¸¸æˆå¼€å§‹å›è°ƒï¼ˆå¿…é¡»å®ç°ï¼‰
     */
    onGameStart() {
        // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
        this.board = this.createInitialBoard();
        this.turn = 0;
        
        // å‘é€åˆå§‹çŠ¶æ€ç»™æ‰€æœ‰ç©å®¶
        this.matchState.players.forEach((player, index) => {
            this.sendToPlayer(player.socketId, 'game_state', {
                board: this.board,
                turn: this.turn,
                mySide: index,
                players: this.matchState.players
            });
        });
    }

    /**
     * è·å–å…¬å…±æ¸¸æˆçŠ¶æ€ï¼ˆç”¨äºæ—è§‚ï¼‰
     */
    getPublicGameState() {
        return {
            status: this.matchState.status,
            players: this.matchState.players.map(p => ({
                nickname: p.nickname,
                title: p.title
            })),
            board: this.getPublicBoard(), // åªè¿”å›å…¬å…±ä¿¡æ¯
            turn: this.turn
        };
    }

    /**
     * å¤„ç†æ¸¸æˆç§»åŠ¨
     */
    handleMove(socket, move) {
        // éªŒè¯ç§»åŠ¨
        if (!this.isValidMove(move)) {
            socket.emit('error', { message: 'Invalid move' });
            return;
        }

        // æ‰§è¡Œç§»åŠ¨
        this.applyMove(move);

        // å¹¿æ’­ç§»åŠ¨
        this.broadcast('move', {
            move,
            board: this.board,
            turn: this.turn
        });

        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        const winner = this.checkWinner();
        if (winner !== null) {
            this.endGame({ winner });
        }
    }
}

module.exports = MyGameRoom;
```

### 2. é›†æˆ AutoMatchManager

```javascript
// server/src/games/mygame/index.js
const BaseGameManager = require('../../gamecore/BaseGameManager');
const AutoMatchManager = require('../../gamecore/AutoMatchManager');
const MyGameRoom = require('./rooms/MyGameRoom');

class MyGameManager extends BaseGameManager {
    constructor(io) {
        super(io, 'mygame', MyGameRoom);
        
        // åˆ›å»ºè‡ªåŠ¨åŒ¹é…ç®¡ç†å™¨
        this.autoMatcher = new AutoMatchManager();
        
        // è®¾ç½®åŒ¹é…æˆåŠŸå›è°ƒ
        this.autoMatcher.setMatchFoundHandler((gameType, players) => {
            this.handleMatchFound(players);
        });
    }

    /**
     * å¤„ç†è‡ªåŠ¨åŒ¹é…è¯·æ±‚
     */
    handleAutoMatch(socket, matchSettings) {
        const result = this.autoMatcher.joinQueue(
            this.gameType,
            socket,
            matchSettings
        );
        
        if (result.success) {
            socket.emit('match_queue_joined', {
                message: 'å·²åŠ å…¥åŒ¹é…é˜Ÿåˆ—',
                queueInfo: this.autoMatcher.getQueueInfo(this.gameType)
            });
        } else {
            socket.emit('match_failed', { message: result.error });
        }
    }

    /**
     * åŒ¹é…æˆåŠŸå¤„ç†
     */
    handleMatchFound(players) {
        // åˆ›å»ºæ–°æˆ¿é—´
        const tier = 'free'; // æˆ–æ ¹æ®åº•è±†ç¡®å®šç­‰çº§
        const roomId = `${this.gameType}_${tier}_${this.rooms[tier].length}`;
        const room = new MyGameRoom(roomId, this.io, tier);
        this.rooms[tier].push(room);

        // å°†ç©å®¶åŠ å…¥æˆ¿é—´
        players.forEach(player => {
            room.playerJoin(player.socket, player.settings);
            player.socket.emit('match_found', {
                roomId: room.roomId,
                message: 'åŒ¹é…æˆåŠŸï¼'
            });
        });
    }

    /**
     * ç©å®¶åŠ å…¥æ¸¸æˆç®¡ç†å™¨
     */
    onPlayerJoin(socket, user) {
        super.onPlayerJoin(socket, user);
        
        // ç›‘å¬è‡ªåŠ¨åŒ¹é…è¯·æ±‚
        socket.on('auto_match', (matchSettings) => {
            this.handleAutoMatch(socket, matchSettings);
        });
        
        // ç›‘å¬å–æ¶ˆåŒ¹é…
        socket.on('cancel_match', () => {
            const userId = socket.user._id.toString();
            this.autoMatcher.leaveQueue(this.gameType, userId);
            socket.emit('match_cancelled');
        });
    }
}

module.exports = MyGameManager;
```

---

## å®¢æˆ·ç«¯é›†æˆ

### 1. ä½¿ç”¨ MatchSettingsPanel

```tsx
// client/src/app/game/mygame/page.tsx
import { MatchSettingsPanel } from '@/components/GameTemplates/MatchSettingsPanel';

export default function MyGameCenter() {
    const [showMatchSettings, setShowMatchSettings] = useState(false);
    const [socket, setSocket] = useState<Socket | null>(null);

    const handleStartAutoMatch = (settings: MatchSettings) => {
        if (!socket) return;
        
        // å‘é€è‡ªåŠ¨åŒ¹é…è¯·æ±‚
        socket.emit('auto_match', settings);
        
        // ç›‘å¬åŒ¹é…ç»“æœ
        socket.on('match_queue_joined', (data) => {
            console.log('å·²åŠ å…¥åŒ¹é…é˜Ÿåˆ—:', data);
            setShowMatchSettings(false);
            // æ˜¾ç¤ºåŒ¹é…ä¸­ç•Œé¢
        });
        
        socket.on('match_found', (data) => {
            console.log('åŒ¹é…æˆåŠŸ:', data);
            // è·³è½¬åˆ°æ¸¸æˆæˆ¿é—´
            router.push(`/game/mygame/play?roomId=${data.roomId}`);
        });
    };

    return (
        <div>
            {showMatchSettings ? (
                <MatchSettingsPanel
                    onStartMatch={handleStartAutoMatch}
                    onCancel={() => setShowMatchSettings(false)}
                />
            ) : (
                <button onClick={() => setShowMatchSettings(true)}>
                    è‡ªåŠ¨åŒ¹é…
                </button>
            )}
        </div>
    );
}
```

### 2. æˆ¿é—´å†…å‡†å¤‡/å¼€å§‹

```tsx
// client/src/app/game/mygame/play/page.tsx
export default function MyGamePlay() {
    const [isReady, setIsReady] = useState(false);
    const [readyTimer, setReadyTimer] = useState<number | null>(null);

    useEffect(() => {
        if (!socket) return;

        // ç›‘å¬å‡†å¤‡æ£€æŸ¥å¼€å§‹
        socket.on('ready_check_start', (data) => {
            console.log('å‡†å¤‡æ£€æŸ¥å¼€å§‹:', data);
            setReadyTimer(data.timeout / 1000); // è½¬æ¢ä¸ºç§’
        });

        // ç›‘å¬æˆ¿é—´çŠ¶æ€æ›´æ–°
        socket.on('room_state', (state) => {
            console.log('æˆ¿é—´çŠ¶æ€:', state);
            // æ›´æ–°UIæ˜¾ç¤ºå…¶ä»–ç©å®¶çš„å‡†å¤‡çŠ¶æ€
        });

        // ç›‘å¬è¢«è¸¢å‡º
        socket.on('kicked', (data) => {
            alert(data.reason);
            router.push('/game/mygame');
        });

        // ç›‘å¬æ¸¸æˆå¼€å§‹
        socket.on('game_start', (data) => {
            console.log('æ¸¸æˆå¼€å§‹!', data);
            setReadyTimer(null);
        });

    }, [socket]);

    const handleReady = () => {
        if (!socket) return;
        socket.emit('player_ready');
        setIsReady(true);
    };

    return (
        <div>
            {readyTimer !== null && (
                <div className="ready-check">
                    <p>è¯·åœ¨ {readyTimer} ç§’å†…ç‚¹å‡»å¼€å§‹</p>
                    <button 
                        onClick={handleReady}
                        disabled={isReady}
                    >
                        {isReady ? 'å·²å‡†å¤‡' : 'å¼€å§‹æ¸¸æˆ'}
                    </button>
                </div>
            )}
        </div>
    );
}
```

---

## å®Œæ•´ç¤ºä¾‹

### æœåŠ¡ç«¯äº‹ä»¶æµç¨‹

```javascript
// 1. ç©å®¶åŠ å…¥æˆ¿é—´ï¼ˆæ‰‹åŠ¨å…¥åº§ï¼‰
socket.on('join_room', async ({ roomId, matchSettings }) => {
    const room = findRoom(roomId);
    await room.playerJoin(socket, matchSettings);
});

// 2. ç©å®¶å‡†å¤‡
socket.on('player_ready', () => {
    room.playerReady(socket);
});

// 3. ç©å®¶å–æ¶ˆå‡†å¤‡
socket.on('player_unready', () => {
    room.playerUnready(socket);
});

// 4. ç©å®¶ç¦»åº§
socket.on('leave_room', () => {
    room.playerLeave(socket);
});

// 5. æ—è§‚
socket.on('spectate', ({ roomId }) => {
    const room = findRoom(roomId);
    room.spectatorJoin(socket);
});
```

### å®¢æˆ·ç«¯äº‹ä»¶æµç¨‹

```typescript
// 1. æ¥æ”¶æˆ¿é—´çŠ¶æ€
socket.on('room_state', (state) => {
    // æ›´æ–°æˆ¿é—´UI
});

// 2. å‡†å¤‡æ£€æŸ¥å¼€å§‹
socket.on('ready_check_start', (data) => {
    // æ˜¾ç¤ºå€’è®¡æ—¶
});

// 3. æ¸¸æˆå¼€å§‹
socket.on('game_start', (data) => {
    // åˆå§‹åŒ–æ¸¸æˆç•Œé¢
});

// 4. è¢«è¸¢å‡º
socket.on('kicked', (data) => {
    // æ˜¾ç¤ºåŸå› å¹¶è¿”å›å¤§å…
});

// 5. æ¸¸æˆç»“æŸ
socket.on('game_over', (result) => {
    // æ˜¾ç¤ºç»“ç®—ç•Œé¢
});
```

---

## äº‹ä»¶æµç¨‹å›¾

### è‡ªåŠ¨åŒ¹é…æµç¨‹

```
å®¢æˆ·ç«¯                    æœåŠ¡ç«¯
  |                         |
  |-- auto_match ---------->|  åŠ å…¥åŒ¹é…é˜Ÿåˆ—
  |<-- match_queue_joined --|
  |                         |
  |      (ç­‰å¾…åŒ¹é…...)      |
  |                         |
  |<-- match_found ---------|  åŒ¹é…æˆåŠŸ
  |                         |
  |-- join_room ----------->|  åŠ å…¥æˆ¿é—´
  |<-- room_state ----------|
  |                         |
  |<-- ready_check_start ---|  å¼€å§‹å‡†å¤‡æ£€æŸ¥
  |                         |
  |-- player_ready -------->|  ç©å®¶å‡†å¤‡
  |                         |
  |<-- game_start ----------|  æ¸¸æˆå¼€å§‹
```

### æ‰‹åŠ¨å…¥åº§æµç¨‹

```
å®¢æˆ·ç«¯                    æœåŠ¡ç«¯
  |                         |
  |-- get_rooms ----------->|  è·å–æˆ¿é—´åˆ—è¡¨
  |<-- room_list -----------|
  |                         |
  |-- join_room ----------->|  åŠ å…¥æŒ‡å®šæˆ¿é—´
  |<-- room_state ----------|
  |                         |
  |      (ç­‰å¾…æ»¡åº§...)      |
  |                         |
  |<-- ready_check_start ---|  æ»¡åº§ï¼Œå¼€å§‹å‡†å¤‡æ£€æŸ¥
  |                         |
  |-- player_ready -------->|  ç©å®¶å‡†å¤‡
  |<-- room_state ----------|  å¹¿æ’­å‡†å¤‡çŠ¶æ€
  |                         |
  |<-- game_start ----------|  æ‰€æœ‰äººå‡†å¤‡æˆ–è¶…æ—¶
```

---

## æœ€ä½³å®è·µ

### 1. æœåŠ¡ç«¯

```javascript
// âœ… æ¨èï¼šä½¿ç”¨ MatchableGameRoom
class MyGameRoom extends MatchableGameRoom {
    constructor(roomId, io, tier) {
        super(io, roomId, 2, tier); // æ˜ç¡®æŒ‡å®šç©å®¶æ•°é‡
    }
}

// âŒ ä¸æ¨èï¼šä»å¤´å®ç°æ‰€æœ‰é€»è¾‘
class MyGameRoom {
    // å¤§é‡é‡å¤ä»£ç ...
}
```

### 2. å®¢æˆ·ç«¯

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ MatchSettingsPanel
<MatchSettingsPanel onStartMatch={handleMatch} />

// âŒ ä¸æ¨èï¼šæ‰‹åŠ¨æ„å»ºè¡¨å•
<form>
  {/* å¤§é‡è¡¨å•ä»£ç ... */}
</form>
```

### 3. ç©å®¶æ•°é‡é…ç½®

```javascript
// ä¸åŒæ¸¸æˆçš„ç©å®¶æ•°é‡
const PLAYER_COUNTS = {
    chess: 2,        // è±¡æ£‹ï¼š2äºº
    gomoku: 2,       // äº”å­æ£‹ï¼š2äºº
    mahjong: 4,      // éº»å°†ï¼š4äºº
    poker: 6,        // æ‰‘å…‹ï¼šæœ€å¤š6äºº
};

// åœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨
super(io, roomId, PLAYER_COUNTS.mahjong, tier);
```

---

## æ€»ç»“

ä½¿ç”¨åŒ¹é…ç³»ç»Ÿæ¨¡æ¿ï¼Œæ‚¨å¯ä»¥ï¼š

1. **å¿«é€Ÿé›†æˆ**ï¼š10åˆ†é’Ÿå®ŒæˆåŒ¹é…ç³»ç»Ÿé›†æˆ
2. **æ ‡å‡†åŒ–**ï¼šæ‰€æœ‰æ¸¸æˆä½¿ç”¨ç»Ÿä¸€çš„åŒ¹é…é€»è¾‘
3. **å¯é…ç½®**ï¼šçµæ´»çš„ç©å®¶æ•°é‡å’ŒåŒ¹é…æ¡ä»¶
4. **é˜²ä½œå¼Š**ï¼šå†…ç½®æ—è§‚é™åˆ¶å’Œåƒµå°¸æ¡Œæ¸…ç†
5. **ç”¨æˆ·å‹å¥½**ï¼š30ç§’å‡†å¤‡æœºåˆ¶å’Œæ¸…æ™°çš„æç¤º

---

**Happy Matching! ğŸ¯**

---

## ğŸ“Š æ‰çº¿ç‡è‡ªåŠ¨ç»Ÿè®¡ç³»ç»Ÿ

### æ¦‚è¿°

æ‰çº¿ç‡è‡ªåŠ¨ç»Ÿè®¡ç³»ç»Ÿä¼šåœ¨æ¯æ¬¡æ¸¸æˆåè‡ªåŠ¨è®¡ç®—å¹¶è®°å½•ç©å®¶çš„æ‰çº¿æ¬¡æ•°ï¼Œç”¨äºåŒ¹é…æ¡ä»¶éªŒè¯ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… åªæœ‰åœ¨**æ¸¸æˆè¿›è¡Œä¸­**æ–­çº¿æ‰è®¡å…¥æ‰çº¿ç‡
- âœ… ç­‰å¾…ä¸­ã€å‡†å¤‡ä¸­ç¦»å¼€ä¸è®¡å…¥æ‰çº¿
- âœ… æ¯æ¬¡æ–­çº¿åè‡ªåŠ¨æ›´æ–°æ•°æ®åº“
- âœ… æ‰çº¿ç‡ = (æ‰çº¿æ¬¡æ•° / æ€»å¯¹å±€æ•°) Ã— 100%

---

### 1. æ•°æ®åº“æ¨¡å‹

#### UserGameStats æ¨¡å‹æ›´æ–°

```javascript
// server/src/models/UserGameStats.js
const UserGameStatsSchema = new mongoose.Schema({
    userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
    gameType: { type: String, required: true },
    rating: { type: Number, default: 1200 },
    gamesPlayed: { type: Number, default: 0 },
    wins: { type: Number, default: 0 },
    losses: { type: Number, default: 0 },
    draws: { type: Number, default: 0 },
    disconnects: { type: Number, default: 0 },  // â­ æ–°å¢ï¼šæ‰çº¿æ¬¡æ•°
    lastPlayedAt: { type: Date, default: Date.now },
    title: { type: String, default: 'åˆå‡ºèŒ…åº' },
    titleRank: { type: Number, default: 1 },
    titleColor: { type: String, default: '#000000' }  // â­ æ–°å¢ï¼šç§°å·é¢œè‰²
});
```

---

### 2. æ‰çº¿ç»Ÿè®¡æœåŠ¡

#### DisconnectTracker æœåŠ¡

ä½ç½®ï¼š`server/src/gamecore/DisconnectTracker.js`

**ä¸»è¦æ–¹æ³•**ï¼š

```javascript
// è®°å½•æ‰çº¿ï¼ˆåªæœ‰æ¸¸æˆä¸­æ–­çº¿æ‰è®¡å…¥ï¼‰
await DisconnectTracker.recordDisconnect(userId, gameType, wasInGame);

// è·å–æ‰çº¿ç‡
const rate = await DisconnectTracker.getDisconnectRate(userId, gameType);

// è·å–å®Œæ•´ç»Ÿè®¡ï¼ˆåŒ…æ‹¬æ‰çº¿ç‡ï¼‰
const stats = await DisconnectTracker.getPlayerStats(userId, gameType);

// é‡ç½®æ‰çº¿è®°å½•ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
await DisconnectTracker.resetDisconnects(userId, gameType);
```

**è¿”å›æ•°æ®ç»“æ„**ï¼š

```javascript
{
    gamesPlayed: 100,      // æ€»å¯¹å±€æ•°
    wins: 55,              // èƒœåœº
    losses: 40,            // è´Ÿåœº
    draws: 5,              // å¹³å±€
    disconnects: 5,        // æ‰çº¿æ¬¡æ•° â­
    rating: 1500,          // ç­‰çº§åˆ†
    title: "æ£‹å›æ–°ç§€",     // ç§°å·
    titleColor: "#4CAF50", // ç§°å·é¢œè‰²
    winRate: 55.0,         // èƒœç‡ (%)
    disconnectRate: 5.0    // æ‰çº¿ç‡ (%) â­
}
```

---

### 3. è‡ªåŠ¨è®°å½•æœºåˆ¶

#### åœ¨ MatchableGameRoom ä¸­é›†æˆ

```javascript
// server/src/gamecore/MatchableGameRoom.js

/**
 * å¤„ç†ç©å®¶æ–­çº¿
 * â­ è‡ªåŠ¨è®°å½•æ‰çº¿ç»Ÿè®¡
 */
async handlePlayerDisconnect(socket) {
    const userId = socket.user._id.toString();
    
    console.log(`[MatchRoom] Player ${socket.user.username} disconnected`);
    
    // æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨æ¸¸æˆä¸­
    const wasInGame = this.matchState.status === 'playing';
    
    // å¦‚æœåœ¨æ¸¸æˆä¸­æ–­çº¿ï¼Œè®°å½•æ‰çº¿ç»Ÿè®¡
    if (wasInGame) {
        try {
            await DisconnectTracker.recordDisconnect(
                socket.user._id,
                this.gameType,
                true // wasInGame = true
            );
            console.log(`[MatchRoom] Disconnect recorded`);
        } catch (error) {
            console.error(`[MatchRoom] Failed to record disconnect:`, error);
        }
    }
    
    // ç§»é™¤ç©å®¶
    this.playerLeave(socket);
    
    // å¦‚æœæ˜¯æ¸¸æˆä¸­æ–­çº¿ï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼ˆå¦‚åˆ¤å¯¹æ‰‹è·èƒœï¼‰
    if (wasInGame) {
        this.onPlayerDisconnectDuringGame(userId);
    }
}

/**
 * æ¸¸æˆä¸­æ–­çº¿çš„ç‰¹æ®Šå¤„ç†ï¼ˆå­ç±»å¯é‡å†™ï¼‰
 */
onPlayerDisconnectDuringGame(userId) {
    // å­ç±»å¯ä»¥é‡å†™æ­¤æ–¹æ³•æ¥å¤„ç†æ¸¸æˆä¸­æ–­çº¿çš„é€»è¾‘
    // ä¾‹å¦‚ï¼šåˆ¤å¯¹æ‰‹è·èƒœã€æš‚åœæ¸¸æˆç­‰
    console.log(`[MatchRoom] Player ${userId} disconnected during game`);
}
```

---

### 4. è°ƒç”¨æµç¨‹

```
ç©å®¶æ–­çº¿
  â†“
handlePlayerDisconnect()
  â†“
æ£€æŸ¥æ¸¸æˆçŠ¶æ€
  â”œâ”€ æ¸¸æˆä¸­ (status === 'playing')
  â”‚   â”œâ”€ è°ƒç”¨ DisconnectTracker.recordDisconnect()
  â”‚   â”œâ”€ disconnects +1
  â”‚   â”œâ”€ è®¡ç®—æ–°çš„æ‰çº¿ç‡
  â”‚   â””â”€ è°ƒç”¨ onPlayerDisconnectDuringGame()
  â””â”€ éæ¸¸æˆä¸­
      â””â”€ ä¸è®°å½•æ‰çº¿
  â†“
ç§»é™¤ç©å®¶ï¼ˆplayerLeaveï¼‰
```

---

### 5. ä½¿ç”¨ç¤ºä¾‹

#### æœåŠ¡ç«¯ï¼ˆGameManagerï¼‰

```javascript
// åœ¨ BaseGameManager æˆ–å…·ä½“æ¸¸æˆçš„ Manager ä¸­
class ChineseChessManager extends BaseGameManager {
    handleDisconnect(socket, room) {
        console.log(`Player disconnected`);
        
        if (room) {
            // è‡ªåŠ¨è®°å½•æ‰çº¿ç»Ÿè®¡
            room.handlePlayerDisconnect(socket);
        }
    }
}
```

#### æœåŠ¡ç«¯ï¼ˆGameRoomï¼‰

```javascript
// åœ¨å…·ä½“æ¸¸æˆçš„ Room ä¸­é‡å†™æ–­çº¿å¤„ç†
class ChineseChessRoom extends MatchableGameRoom {
    onPlayerDisconnectDuringGame(userId) {
        // æ¸¸æˆä¸­æ–­çº¿çš„ç‰¹æ®Šå¤„ç†
        console.log(`Player ${userId} disconnected during game`);
        
        // åˆ¤å¯¹æ‰‹è·èƒœ
        const opponent = this.matchState.players.find(p => p.userId !== userId);
        if (opponent) {
            this.endGame({
                winner: opponent.userId,
                reason: 'opponent_disconnected'
            });
        }
    }
}
```

#### å®¢æˆ·ç«¯ï¼ˆæŸ¥çœ‹ç»Ÿè®¡ï¼‰

```typescript
// è·å–ç©å®¶ç»Ÿè®¡ä¿¡æ¯
useEffect(() => {
    socket.emit('get_stats', { gameType: 'chinesechess' });
    
    socket.on('user_stats', (stats) => {
        console.log('ç©å®¶ç»Ÿè®¡:', stats);
        console.log('æ‰çº¿ç‡:', stats.disconnectRate + '%');
    });
}, []);
```

---

### 6. æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
[MatchRoom] Player Alice disconnected from room chinesechess_free_0
[MatchRoom] Disconnect recorded for player Alice
[DisconnectTracker] Recorded disconnect for user 507f1f77bcf86cd799439011 in chinesechess
[DisconnectTracker] Total disconnects: 3, Games played: 50, Rate: 6.0%
[MatchRoom] Player 507f1f77bcf86cd799439011 disconnected during game
```

---

### 7. åŒ¹é…æ¡ä»¶éªŒè¯

æ‰çº¿ç‡ä¼šåœ¨ç©å®¶å°è¯•å…¥åº§æ—¶è‡ªåŠ¨éªŒè¯ï¼š

```javascript
// MatchRoomState.js - canPlayerJoin()

// æ£€æŸ¥ç©å®¶çš„æ‰çº¿ç‡æ˜¯å¦ç¬¦åˆç¬¬ä¸€ä¸ªç©å®¶çš„è¦æ±‚
const disconnectRate = playerStats.gamesPlayed > 0
    ? (playerStats.disconnects / playerStats.gamesPlayed) * 100
    : 0;

if (disconnectRate > maxDisconnectRate) {
    console.log(`[MatchRoom] Player rejected: disconnectRate ${disconnectRate.toFixed(1)}% exceeds max ${maxDisconnectRate}%`);
    return false;
}
```

**ç¤ºä¾‹**ï¼š
```
ç¬¬ä¸€ä¸ªç©å®¶è®¾ç½®ï¼šæœ€å¤§æ‰çº¿ç‡ 20%

ç©å®¶ A å°è¯•å…¥åº§ï¼š
  - æ€»å¯¹å±€ï¼š100åœº
  - æ‰çº¿æ¬¡æ•°ï¼š15æ¬¡
  - æ‰çº¿ç‡ï¼š15%
  - âœ… ç¬¦åˆæ¡ä»¶ï¼Œå…è®¸å…¥åº§

ç©å®¶ B å°è¯•å…¥åº§ï¼š
  - æ€»å¯¹å±€ï¼š100åœº
  - æ‰çº¿æ¬¡æ•°ï¼š25æ¬¡
  - æ‰çº¿ç‡ï¼š25%
  - âŒ è¶…è¿‡é™åˆ¶ï¼Œæ‹’ç»å…¥åº§
```

---

### 8. å…³é”®ç‰¹æ€§

1. **æ™ºèƒ½åˆ¤æ–­**ï¼šåªæœ‰æ¸¸æˆè¿›è¡Œä¸­æ–­çº¿æ‰è®¡å…¥æ‰çº¿ç‡
2. **è‡ªåŠ¨è®¡ç®—**ï¼šæ¯æ¬¡æ–­çº¿åè‡ªåŠ¨æ›´æ–°ç»Ÿè®¡æ•°æ®
3. **ç²¾ç¡®ç»Ÿè®¡**ï¼šæ‰çº¿ç‡ = æ‰çº¿æ¬¡æ•° / æ€»å¯¹å±€æ•°
4. **é˜²ä½œå¼Š**ï¼šç­‰å¾…ä¸­æˆ–å‡†å¤‡ä¸­ç¦»å¼€ä¸è®¡å…¥æ‰çº¿
5. **å¯æ‰©å±•**ï¼šå­ç±»å¯é‡å†™ `onPlayerDisconnectDuringGame` å¤„ç†ç‰¹æ®Šé€»è¾‘
6. **ç®¡ç†å‘˜åŠŸèƒ½**ï¼šæ”¯æŒé‡ç½®æ‰çº¿è®°å½•

---

### 9. å®Œæ•´æ•°æ®æµ

```
æ¸¸æˆå¼€å§‹
  â†“
ç©å®¶ A æ–­çº¿
  â†“
handlePlayerDisconnect(socketA)
  â†“
æ£€æµ‹åˆ° status === 'playing'
  â†“
DisconnectTracker.recordDisconnect(userIdA, 'chinesechess', true)
  â†“
æ•°æ®åº“æ›´æ–°ï¼š
  - disconnects: 5 â†’ 6
  - disconnectRate: 5.0% â†’ 6.0%
  â†“
onPlayerDisconnectDuringGame(userIdA)
  â†“
åˆ¤ç©å®¶ B è·èƒœ
  â†“
endGame({ winner: userIdB, reason: 'opponent_disconnected' })
```

---

## æ€»ç»“

ç°åœ¨ç³»ç»Ÿå·²ç»å®Œæ•´å®ç°äº†ï¼š

1. âœ… **æ¸¸æˆæ¡Œçº§åˆ«çš„åŒ¹é…æ¡ä»¶**ï¼šæ¯ä¸ªæ¡Œå­ç‹¬ç«‹ï¼Œç”±ç¬¬ä¸€ä¸ªç©å®¶è®¾ç½®
2. âœ… **ç­‰çº§åˆ†èŒƒå›´ç­›é€‰**ï¼šå¯é€‰çš„ç­‰çº§åˆ†åŒ¹é…æ¡ä»¶
3. âœ… **è‡ªåŠ¨æ‰çº¿ç»Ÿè®¡**ï¼šæ¸¸æˆä¸­æ–­çº¿è‡ªåŠ¨è®°å½•
4. âœ… **æ‰çº¿ç‡è®¡ç®—**ï¼šè‡ªåŠ¨è®¡ç®—å¹¶å­˜å‚¨åœ¨æ•°æ®åº“
5. âœ… **åŒ¹é…æ¡ä»¶éªŒè¯**ï¼šåç»­ç©å®¶å¿…é¡»ç¬¦åˆæ‰çº¿ç‡é™åˆ¶
6. âœ… **å®Œæ•´çš„æ—¥å¿—**ï¼šæ–¹ä¾¿è°ƒè¯•å’Œç›‘æ§
7. âœ… **å¯æ‰©å±•æ€§**ï¼šå­ç±»å¯é‡å†™æ–­çº¿å¤„ç†é€»è¾‘

æ‰€æœ‰åŠŸèƒ½éƒ½å·²ç»æ¨¡æ¿åŒ–ï¼Œæ–°æ¸¸æˆåªéœ€ç»§æ‰¿ `MatchableGameRoom` å³å¯è‡ªåŠ¨è·å¾—è¿™äº›åŠŸèƒ½ï¼ğŸ‰

---

**Happy Coding! ğŸš€**
