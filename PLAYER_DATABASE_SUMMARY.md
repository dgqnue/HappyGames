# ç©å®¶æ•°æ®åº“ç³»ç»Ÿå®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®æ¨¡å‹è®¾è®¡ (`server/src/models/User.js`)

#### æ ¸å¿ƒå­—æ®µ
- **èº«ä»½ä¿¡æ¯**ï¼š
  - `userId` - å¹³å°å”¯ä¸€ç¼–å· (HG00000001, HG00000002, ...)ï¼Œæ°¸ä¸å¯æ”¹
  - `username` - Pi ç”¨æˆ·åï¼Œæ°¸ä¸å¯æ”¹
  - `piId` - Pi Network IDï¼Œæ°¸ä¸å¯æ”¹

- **ä¸ªäººèµ„æ–™**ï¼š
  - `nickname` - æ˜µç§°ï¼ˆé»˜è®¤ä¸ Pi ç”¨æˆ·åç›¸åŒï¼Œå¯ä¿®æ”¹ä½†ä¸èƒ½é‡å¤ï¼‰
  - `avatar` - å¤´åƒ URLï¼ˆé»˜è®¤å¡é€šå°ç†Šå›¾ç‰‡ï¼‰
  - `gender` - æ€§åˆ«ï¼ˆé¦–æ¬¡ç™»å½•éšæœºç”Ÿæˆï¼Œå¯ä¿®æ”¹ï¼‰

- **æ¸¸æˆè´§å¸**ï¼š
  - `happyBeans` - æ¬¢ä¹è±†æ•°é‡ï¼ˆæ–°ç”¨æˆ·èµ é€ 10000ï¼‰

- **æ¸¸æˆç»Ÿè®¡**ï¼š
  - `gameStats` - æ•°ç»„ï¼Œæ¯ä¸ªæ¸¸æˆä¸€ä¸ªå¯¹è±¡
  - åŒ…å«ï¼šç­‰çº§åˆ†ã€ç§°å·ã€èƒœç‡ã€æ‰çº¿ç‡ã€è¿èƒœè®°å½•ç­‰

#### å®ä¾‹æ–¹æ³•
- `getOrCreateGameStats(gameType, gameName)` - è·å–æˆ–åˆ›å»ºæ¸¸æˆç»Ÿè®¡
- `updateGameStats(gameType, updates)` - æ›´æ–°æ¸¸æˆç»Ÿè®¡
- `addHappyBeans(amount)` - å¢åŠ æ¬¢ä¹è±†
- `deductHappyBeans(amount)` - æ‰£é™¤æ¬¢ä¹è±†

#### é™æ€æ–¹æ³•
- `generateUserId()` - ç”Ÿæˆå”¯ä¸€ userId
- `isNicknameAvailable(nickname, excludeUserId)` - æ£€æŸ¥æ˜µç§°å¯ç”¨æ€§

### 2. è®¤è¯ä¸­é—´ä»¶ (`server/src/middleware/auth.js`)

#### åŠŸèƒ½
- **piAuth** - HTTP è¯·æ±‚è®¤è¯
  - éªŒè¯ JWT token
  - é¦–æ¬¡ç™»å½•è‡ªåŠ¨åˆ›å»ºç”¨æˆ·
  - æ›´æ–°ç™»å½•æ—¶é—´å’Œæ¬¡æ•°

- **socketAuth** - Socket.IO è¿æ¥è®¤è¯
  - ç”¨äºæ¸¸æˆè¿æ¥çš„è®¤è¯

- **optionalAuth** - å¯é€‰è®¤è¯
  - ç”¨äºä¸éœ€è¦å¼ºåˆ¶ç™»å½•çš„æ¥å£

#### è‡ªåŠ¨åˆ›å»ºç”¨æˆ·
é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨ï¼š
- ç”Ÿæˆå”¯ä¸€ userId
- è®°å½• Pi ç”¨æˆ·å
- è®¾ç½®é»˜è®¤æ˜µç§°
- è®¾ç½®é»˜è®¤å¤´åƒ
- éšæœºç”Ÿæˆæ€§åˆ«
- èµ é€ 10000 æ¬¢ä¹è±†
- ç”Ÿæˆæ¨èç 

### 3. ç”¨æˆ· API (`server/src/routes/user.js`)

#### æ¥å£åˆ—è¡¨
1. `GET /api/user/profile` - è·å–ç”¨æˆ·ä¿¡æ¯
2. `PUT /api/user/nickname` - æ›´æ–°æ˜µç§°ï¼ˆæ£€æŸ¥é‡å¤ï¼‰
3. `PUT /api/user/gender` - æ›´æ–°æ€§åˆ«
4. `POST /api/user/avatar` - ä¸Šä¼ å¤´åƒï¼ˆé™åˆ¶ 1MBï¼‰
5. `GET /api/user/check-nickname/:nickname` - æ£€æŸ¥æ˜µç§°å¯ç”¨æ€§
6. `GET /api/user/happy-beans` - è·å–æ¬¢ä¹è±†ä½™é¢
7. `GET /api/user/game-stats/:gameType` - è·å–æŒ‡å®šæ¸¸æˆç»Ÿè®¡
8. `GET /api/user/game-stats` - è·å–æ‰€æœ‰æ¸¸æˆç»Ÿè®¡

### 4. æœåŠ¡å™¨é…ç½®æ›´æ–° (`server/src/index.js`)

- æ·»åŠ é™æ€æ–‡ä»¶æœåŠ¡ï¼š
  - `/images` - é»˜è®¤å›¾ç‰‡ï¼ˆåŒ…æ‹¬é»˜è®¤å¤´åƒï¼‰
  - `/uploads` - ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆå¤´åƒï¼‰

- æ³¨å†Œç”¨æˆ· API è·¯ç”±ï¼š
  - `/api/user/*` - ç”¨æˆ·èµ„æ–™ç®¡ç†

### 5. æ–‡æ¡£

- **PLAYER_DATABASE.md** - å®Œæ•´çš„æ•°æ®åº“ç³»ç»Ÿæ–‡æ¡£
  - æ•°æ®ç»“æ„è¯´æ˜
  - API æ¥å£æ–‡æ¡£
  - ä½¿ç”¨ç¤ºä¾‹
  - æ³¨æ„äº‹é¡¹

## ğŸ“‹ æ•°æ®æµç¨‹

### ç”¨æˆ·é¦–æ¬¡ç™»å½•æµç¨‹
```
1. ç”¨æˆ·ä½¿ç”¨ Pi Network ç™»å½•
   â†“
2. å‰ç«¯è·å– JWT token
   â†“
3. å‰ç«¯è¯·æ±‚ APIï¼ˆæºå¸¦ tokenï¼‰
   â†“
4. è®¤è¯ä¸­é—´ä»¶éªŒè¯ token
   â†“
5. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   â†“
6. ä¸å­˜åœ¨ â†’ è‡ªåŠ¨åˆ›å»ºç”¨æˆ·
   - ç”Ÿæˆ userId: HG00000001
   - è®¾ç½® username: pi_user_123
   - è®¾ç½® nickname: pi_user_123
   - è®¾ç½® avatar: /images/default-avatar.png
   - éšæœº gender: male/female
   - èµ é€ happyBeans: 10000
   â†“
7. è¿”å›ç”¨æˆ·ä¿¡æ¯
```

### æ¸¸æˆæ•°æ®è®°å½•æµç¨‹
```
1. ç”¨æˆ·å¼€å§‹æ¸¸æˆ
   â†“
2. æœåŠ¡ç«¯è°ƒç”¨ getOrCreateGameStats()
   - é¦–æ¬¡ç©è¯¥æ¸¸æˆ â†’ åˆ›å»ºç»Ÿè®¡è®°å½•
   - å·²ç©è¿‡ â†’ è·å–ç°æœ‰è®°å½•
   â†“
3. æ¸¸æˆè¿›è¡Œä¸­...
   â†“
4. æ¸¸æˆç»“æŸ
   â†“
5. æœåŠ¡ç«¯è°ƒç”¨ updateGameStats()
   - æ›´æ–°èƒœè´Ÿåœºæ¬¡
   - æ›´æ–°ç­‰çº§åˆ†
   - æ›´æ–°è¿èƒœè®°å½•
   - è‡ªåŠ¨è®¡ç®—èƒœç‡å’Œæ‰çº¿ç‡
   â†“
6. æ›´æ–°æ¬¢ä¹è±†
   - deductHappyBeans() - ä¸‹æ³¨
   - addHappyBeans() - è·èƒœå¥–åŠ±
   â†“
7. ä¿å­˜åˆ°æ•°æ®åº“
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. èº«ä»½å”¯ä¸€æ€§
- `userId`ã€`username`ã€`piId` æ°¸ä¸å¯æ”¹
- ç¡®ä¿ç”¨æˆ·èº«ä»½çš„å”¯ä¸€æ€§å’Œå¯è¿½æº¯æ€§

### 2. æ˜µç§°ç®¡ç†
- é»˜è®¤ä¸ Pi ç”¨æˆ·åç›¸åŒ
- å¯ä¿®æ”¹ï¼Œä½†å¿…é¡»å”¯ä¸€
- æä¾›å®æ—¶æ£€æŸ¥æ¥å£

### 3. å¤´åƒç³»ç»Ÿ
- é»˜è®¤ä½¿ç”¨å¯çˆ±çš„å¡é€šå°ç†Šå›¾ç‰‡
- æ”¯æŒç”¨æˆ·ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ
- é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆ1MBï¼‰å’Œç±»å‹
- è‡ªåŠ¨åˆ é™¤æ—§å¤´åƒ

### 4. æ€§åˆ«ç³»ç»Ÿ
- é¦–æ¬¡ç™»å½•éšæœºç”Ÿæˆ
- ç”¨äºé€‚é…ç©å®¶è£…æ‰®å’ŒéŸ³æ•ˆ
- å¯è‡ªç”±ä¿®æ”¹

### 5. æ¸¸æˆæ•°æ®ç»Ÿè®¡
- æ”¯æŒå¤šä¸ªæ¸¸æˆ
- æ¯ä¸ªæ¸¸æˆç‹¬ç«‹ç»Ÿè®¡
- è‡ªåŠ¨è®¡ç®—èƒœç‡å’Œæ‰çº¿ç‡
- è®°å½•è¿èƒœè®°å½•
- æ”¯æŒæ¸¸æˆç‰¹å®šæ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰

### 6. æ¬¢ä¹è±†ç³»ç»Ÿ
- æ–°ç”¨æˆ·èµ é€ 10000
- æä¾›å¢åŠ å’Œæ‰£é™¤æ–¹æ³•
- æ‰£é™¤å‰æ£€æŸ¥ä½™é¢

## ğŸ“ æ–‡ä»¶ç»“æ„

```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ User.js                    # ç”¨æˆ·æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ user.js                    # ç”¨æˆ· API è·¯ç”±
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.js                    # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ index.js                       # æœåŠ¡å™¨å…¥å£ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ default-avatar.png         # é»˜è®¤å¤´åƒ
â”‚   â””â”€â”€ uploads/
â”‚       â””â”€â”€ avatars/                   # ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒ
â””â”€â”€ PLAYER_DATABASE.md                 # æ•°æ®åº“æ–‡æ¡£
```

## ğŸ”§ ä¾èµ–åŒ…

éœ€è¦å®‰è£…ä»¥ä¸‹ npm åŒ…ï¼š

```bash
npm install multer  # æ–‡ä»¶ä¸Šä¼ å¤„ç†
npm install jsonwebtoken  # JWT è®¤è¯
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
```javascript
const response = await fetch('/api/user/profile', {
    headers: {
        'Authorization': `Bearer ${token}`
    }
});

const { data } = await response.json();
console.log(data.userId);      // HG00000001
console.log(data.nickname);    // ç©å®¶æ˜µç§°
console.log(data.happyBeans);  // 10000
```

### å‰ç«¯ï¼šæ›´æ–°æ˜µç§°
```javascript
const response = await fetch('/api/user/nickname', {
    method: 'PUT',
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ nickname: 'è±¡æ£‹å¤§å¸ˆ' })
});
```

### å‰ç«¯ï¼šä¸Šä¼ å¤´åƒ
```javascript
const formData = new FormData();
formData.append('avatar', file);

const response = await fetch('/api/user/avatar', {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${token}`
    },
    body: formData
});
```

### æœåŠ¡ç«¯ï¼šæ›´æ–°æ¸¸æˆæ•°æ®
```javascript
// æ¸¸æˆå¼€å§‹
const user = await User.findById(userId);
const stats = user.getOrCreateGameStats('chinesechess', 'ä¸­å›½è±¡æ£‹');
await user.save();

// æ¸¸æˆç»“æŸ
user.updateGameStats('chinesechess', {
    gamesPlayed: stats.gamesPlayed + 1,
    wins: stats.wins + 1,
    rating: newRating
});

user.deductHappyBeans(100);  // ä¸‹æ³¨
user.addHappyBeans(200);     // è·èƒœå¥–åŠ±

await user.save();
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é»˜è®¤å¤´åƒ**ï¼š
   - éœ€è¦å°†å¡é€šå°ç†Šå›¾ç‰‡ä¿å­˜åˆ° `server/public/images/default-avatar.png`
   - ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®

2. **æ–‡ä»¶ä¸Šä¼ **ï¼š
   - éœ€è¦åˆ›å»ºä¸Šä¼ ç›®å½•ï¼š`server/public/uploads/avatars`
   - ç¡®ä¿ç›®å½•æœ‰å†™æƒé™

3. **è®¤è¯ä¸­é—´ä»¶**ï¼š
   - æ‰€æœ‰ç”¨æˆ· API éƒ½éœ€è¦ä½¿ç”¨ `piAuth` ä¸­é—´ä»¶
   - ç¡®ä¿åœ¨è·¯ç”±ä¸­æ­£ç¡®åº”ç”¨

4. **æ•°æ®åº“ç´¢å¼•**ï¼š
   - å·²ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
   - é¦–æ¬¡è¿è¡Œæ—¶ MongoDB ä¼šè‡ªåŠ¨åˆ›å»º

5. **æ˜µç§°å”¯ä¸€æ€§**ï¼š
   - ä¿®æ”¹æ˜µç§°å‰å¿…é¡»æ£€æŸ¥å¯ç”¨æ€§
   - ä½¿ç”¨ `isNicknameAvailable` é™æ€æ–¹æ³•

## ğŸ”œ åç»­å·¥ä½œ

1. **é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ**ï¼š
   - æ›´æ–° Socket.IO è®¤è¯ä½¿ç”¨æ–°çš„ `socketAuth`
   - æ›´æ–°æ¸¸æˆç»“æŸé€»è¾‘ä»¥è®°å½•ç»Ÿè®¡æ•°æ®

2. **å‰ç«¯å¼€å‘**ï¼š
   - åˆ›å»ºä¸ªäººä¸»é¡µç»„ä»¶
   - åˆ›å»ºå¤´åƒä¸Šä¼ ç»„ä»¶
   - åˆ›å»ºæ˜µç§°ä¿®æ”¹ç»„ä»¶
   - åˆ›å»ºæ¸¸æˆç»Ÿè®¡å±•ç¤ºç»„ä»¶

3. **åŠŸèƒ½æ‰©å±•**ï¼š
   - ç§°å·ç³»ç»Ÿï¼ˆæ ¹æ®ç­‰çº§åˆ†è‡ªåŠ¨æ›´æ–°ï¼‰
   - æˆå°±ç³»ç»Ÿ
   - æ’è¡Œæ¦œç³»ç»Ÿ
   - VIP ç³»ç»Ÿ

## ğŸ“ æ€»ç»“

ç©å®¶æ•°æ®åº“ç³»ç»Ÿå·²ç»å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å®Œæ•´çš„ç”¨æˆ·æ•°æ®æ¨¡å‹
- âœ… è‡ªåŠ¨ç”¨æˆ·æ³¨å†Œå’Œè®¤è¯
- âœ… ç”¨æˆ·èµ„æ–™ç®¡ç† API
- âœ… æ¸¸æˆæ•°æ®ç»Ÿè®¡ç³»ç»Ÿ
- âœ… å¤´åƒä¸Šä¼ åŠŸèƒ½
- âœ… æ¬¢ä¹è±†ç®¡ç†
- âœ… å®Œæ•´çš„æ–‡æ¡£

ç³»ç»Ÿè®¾è®¡éµå¾ªäº†æ‰€æœ‰éœ€æ±‚ï¼š
- userId æ°¸ä¸å¯æ”¹
- Pi ç”¨æˆ·åæ°¸ä¸å¯æ”¹
- æ˜µç§°å¯æ”¹ä½†ä¸èƒ½é‡å¤
- æ€§åˆ«éšæœºç”Ÿæˆå¯ä¿®æ”¹
- é»˜è®¤å¤´åƒä¸ºå¡é€šå°ç†Š
- æ”¯æŒå¤šæ¸¸æˆæ•°æ®ç»Ÿè®¡
- æ–°ç”¨æˆ·èµ é€ 10000 æ¬¢ä¹è±†

ç°åœ¨å¯ä»¥å¼€å§‹é›†æˆåˆ°å‰ç«¯å’Œæ¸¸æˆé€»è¾‘ä¸­äº†ï¼
