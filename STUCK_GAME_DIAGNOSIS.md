# æ¸¸æˆä¸­é€”"èµ°ä¸åŠ¨"é—®é¢˜ - è¯Šæ–­æŒ‡å—

## é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šï¼šèµ°äº†å‡ ä¸ªå›åˆä»¥åï¼Œçªç„¶èµ°ä¸åŠ¨äº†

è¿™æ„å‘³ç€æ¸¸æˆè¿›è¡Œåˆ°æŸä¸ªé˜¶æ®µåï¼Œç©å®¶æ— æ³•ç»§ç»­ç§»åŠ¨æ£‹å­ã€‚

## å¯èƒ½çš„åŸå› åˆ†æ

### 1. **å›åˆ(Turn)çŠ¶æ€åŒæ­¥å¤±è´¥**
æœåŠ¡å™¨è®¤ä¸ºAç©å®¶å¯ä»¥ç§»åŠ¨ï¼Œä½†å®¢æˆ·ç«¯æ˜¾ç¤ºBç©å®¶çš„å›åˆ
- ç—‡çŠ¶ï¼šç‚¹å‡»è‡ªå·±çš„æ£‹å­æ— ååº”ï¼Œæ˜¾ç¤º"ä¸æ˜¯æˆ‘çš„å›åˆ"
- åŸå› ï¼šmove äº‹ä»¶ä¸­çš„ turn æ²¡æœ‰æ­£ç¡®æ›´æ–°åˆ°å®¢æˆ·ç«¯

### 2. **mySideæœªæ­£ç¡®åˆå§‹åŒ–**
æ¸¸æˆå¼€å§‹æ—¶ï¼Œç©å®¶çš„æ–¹ï¼ˆçº¢æ–¹'r'æˆ–é»‘æ–¹'b'ï¼‰æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®
- ç—‡çŠ¶ï¼šcurrentTurn å’Œ mySide éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½† isMyTurn ä»ä¸º false
- åŸå› ï¼šgame_start äº‹ä»¶æ²¡æœ‰æ­£ç¡®ä¼ é€’ mySide ä¿¡æ¯

### 3. **æ¸¸æˆçŠ¶æ€å˜ä¸ºéplaying**
æ¸¸æˆçŠ¶æ€ä» 'playing' å˜æˆäº†å…¶ä»–çŠ¶æ€ï¼ˆå¦‚ 'idle' æˆ– 'matching'ï¼‰
- ç—‡çŠ¶ï¼šæ— æ³•ç‚¹å‡»æ£‹ç›˜ï¼Œæˆ–çœ‹åˆ°çŠ¶æ€å˜åŒ–çš„æ—¥å¿—
- åŸå› ï¼šç½‘ç»œé”™è¯¯ã€ç©å®¶æ‰çº¿ã€æ¸¸æˆå¼‚å¸¸ç»“æŸç­‰

### 4. **ç½‘ç»œè¿æ¥æ–­å¼€**
å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„Socket.IOè¿æ¥æ–­å¼€
- ç—‡çŠ¶ï¼šæ— ä»»ä½•ååº”ï¼Œå¯èƒ½çœ‹åˆ°è¿æ¥é”™è¯¯æ—¥å¿—
- åŸå› ï¼šç½‘ç»œä¸ç¨³å®šã€å®¢æˆ·ç«¯å¡é¡¿ç­‰

### 5. **æ£‹ç›˜æ•°æ®ä¸å›åˆçŠ¶æ€ä¸åŒæ­¥**
æ£‹ç›˜æ˜¾ç¤ºçš„ä½ç½®ä¸æœåŠ¡å™¨ç»´æŠ¤çš„æ£‹ç›˜ä¸ä¸€è‡´
- ç—‡çŠ¶ï¼šæ£‹å­æ˜¾ç¤ºä½ç½®é”™è¯¯ï¼Œæˆ–æ— æ•ˆçš„ç§»åŠ¨è¢«æ‹’ç»
- åŸå› ï¼šæŸæ¬¡moveäº‹ä»¶æ²¡æœ‰è¢«æ­£ç¡®å¤„ç†

## å¿«é€Ÿè¯Šæ–­æ­¥éª¤

### Step 1: æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° **Console** æ ‡ç­¾

### Step 2: å°è¯•ç§»åŠ¨æ£‹å­ï¼ŒæŸ¥çœ‹æ—¥å¿—

åœ¨æ§åˆ¶å°ä¸­æŸ¥çœ‹ä»¥ä¸‹å…³é”®æ—¥å¿—ï¼š

```
[ChineseChessDisplay] updateGameState: {turn: "r", mySide: "r", isPlaying: true, tableState: {...}}
[BoardClick] Clicked at (row, col), Current Turn: r, My Side: r
[BoardClick] Clicked Piece: R, Is My Turn: true, Selected: ...
[BoardClick] Sending move: (fromX, fromY) â†’ (toX, toY)
```

### Step 3: æ ¹æ®æ—¥å¿—åˆ¤æ–­é—®é¢˜

**æƒ…å†µAï¼šæ˜¾ç¤º "NOT my turn"**
```
[BoardClick] NOT my turn: currentTurn=b, mySide=r
```
ğŸ‘‰ **é—®é¢˜**ï¼šå½“å‰ä¸æ˜¯ä½ çš„å›åˆã€‚ç­‰å¾…å¯¹æ–¹ç§»åŠ¨ï¼Œæˆ–æŸ¥çœ‹æ£‹ç›˜ä¸Šçš„å›åˆæç¤ºã€‚

**æƒ…å†µBï¼šmySide ä¸º undefined**
```
[ChineseChessDisplay] updateGameState: {turn: "r", mySide: undefined, isPlaying: true}
```
ğŸ‘‰ **é—®é¢˜**ï¼šmySide æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®ã€‚é‡æ–°åŠ å…¥æ¸¸æˆæˆ–åˆ·æ–°é¡µé¢ã€‚

**æƒ…å†µCï¼šisPlaying ä¸º false**
```
[ChineseChessDisplay] updateGameState: {turn: "r", mySide: "r", isPlaying: false}
```
ğŸ‘‰ **é—®é¢˜**ï¼šæ¸¸æˆä¸åœ¨è¿›è¡ŒçŠ¶æ€ã€‚æ¸¸æˆå¯èƒ½å·²ç»“æŸæˆ–å‡ºç°å¼‚å¸¸ã€‚

**æƒ…å†µDï¼šæ²¡æœ‰çœ‹åˆ°ä»»ä½•æ—¥å¿—**
```
[ChineseChessDisplay] updateGameState: tableClient is null
```
ğŸ‘‰ **é—®é¢˜**ï¼štableClient æœªåˆå§‹åŒ–ã€‚é¡µé¢å¯èƒ½å‡ºç°é—®é¢˜ï¼Œå°è¯•åˆ·æ–°ã€‚

## æœåŠ¡å™¨æ—¥å¿—è¯Šæ–­

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š

### æ£€æŸ¥handleMoveæ˜¯å¦è¢«æ‹’ç»

```
[ChineseChessTable] handleMove rejected: side r is not current turn b
```
ğŸ‘‰ æœåŠ¡å™¨è®¤ä¸ºä¸æ˜¯ä½ çš„å›åˆ

```
[ChineseChessTable] handleMove rejected: status is idle, not 'playing'
```
ğŸ‘‰ æ¸¸æˆçŠ¶æ€å¼‚å¸¸ï¼Œä¸åœ¨ 'playing' çŠ¶æ€

```
[ChineseChessTable] handleMove rejected: invalid move from (x,y) to (x,y)
```
ğŸ‘‰ ç§»åŠ¨ä¸ç¬¦åˆè±¡æ£‹è§„åˆ™

### æ£€æŸ¥moveäº‹ä»¶æ˜¯å¦è¢«æ­£ç¡®å¹¿æ’­

```
[ChineseChessTable] Broadcasting move: captured=null, from=(x,y) to=(x,y)
[ChineseChessTableClient] Move event received from server: {move: {...}, captured: null}
[ChineseChessTableClient] handleMove: Calling onMove callback
```
ğŸ‘‰ move äº‹ä»¶è¢«æ­£ç¡®å¤„ç†

## å¸¸è§è§£å†³æ–¹æ³•

### æ–¹æ³•1ï¼šé‡æ–°åŠ å…¥æ¸¸æˆ
1. ç‚¹å‡»ç¦»å¼€æ¸¸æˆæŒ‰é’®
2. é‡æ–°é€‰æ‹©æ¸¸æˆæ¡Œ
3. ç­‰å¾…å¯¹æ–¹å‡†å¤‡å¹¶å¼€å§‹æ–°æ¸¸æˆ

### æ–¹æ³•2ï¼šåˆ·æ–°é¡µé¢
æŒ‰ `F5` åˆ·æ–°é¡µé¢ï¼Œé‡æ–°è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨

### æ–¹æ³•3ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥
1. æ‰“å¼€ DevTools ä¸­çš„ **Network** æ ‡ç­¾
2. æŸ¥çœ‹ WebSocket è¿æ¥çŠ¶æ€ï¼ˆfilter: wsï¼‰
3. å¦‚æœè¿æ¥æ–­å¼€ï¼ˆçº¢è‰²ï¼‰ï¼Œè¯´æ˜ç½‘ç»œå‡ºç°é—®é¢˜

### æ–¹æ³•4ï¼šæ£€æŸ¥æ¸¸æˆçŠ¶æ€
åœ¨ Console ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç æŸ¥çœ‹å®Œæ•´çŠ¶æ€ï¼š
```javascript
// æŸ¥çœ‹å½“å‰æ¸¸æˆæ¡Œçš„å®Œæ•´çŠ¶æ€
console.log(document.querySelector('[data-game-client]')?._gameClient?.state);
```

## å¦‚æœé—®é¢˜æŒç»­å‘ç”Ÿ

è¯·æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æµè§ˆå™¨Consoleæ—¥å¿—** - å¤åˆ¶ F12 ä¸­çš„æ‰€æœ‰ç›¸å…³æ—¥å¿—
2. **æœåŠ¡å™¨æ—¥å¿—** - å¤åˆ¶æœåŠ¡å™¨æ§åˆ¶å°çš„ç›¸å…³æ—¥å¿—
3. **å…·ä½“æ­¥éª¤** - æè¿°èµ°äº†å¤šå°‘å›åˆåå‡ºç°é—®é¢˜
4. **ç²¾ç¡®æ“ä½œ** - å“ªä¸¤ä¸ªæ£‹å­åœ¨è¿›è¡Œç§»åŠ¨æ—¶å‡ºç°é—®é¢˜
5. **æ¸¸æˆä¿¡æ¯** - æ˜¯çº¢æ–¹è¿˜æ˜¯é»‘æ–¹ï¼Œæˆ¿é—´çº§åˆ«ç­‰

ç„¶åè”ç³»å¼€å‘è€…è¿›è¡Œæ·±åº¦è¯Šæ–­ã€‚

## é˜²é‡è§¦å‘æ—¥å¿—

å¦‚æœä¹‹å‰ä¿®å¤äº†éŸ³æ•ˆé—®é¢˜ï¼Œå¯èƒ½ä¼šçœ‹åˆ°ï¼š
```
[ChineseChessDisplay] Skipping audio eat - played too recently
```
è¿™æ˜¯æ­£å¸¸çš„ï¼Œè¡¨ç¤ºé˜²é‡æœºåˆ¶åœ¨å·¥ä½œã€‚

## ç›¸å…³æ–‡ä»¶

- è¯Šæ–­ä»£ç ä½ç½®ï¼š`client/src/games/chinesechess/gamepagehierarchy/ChineseChessDisplayPlugin.tsx`
- æœåŠ¡å™¨å¤„ç†ä½ç½®ï¼š`server/src/games/chinesechess/gamepagehierarchy/ChineseChessTable.js`
- æ£‹ç›˜éªŒè¯ï¼š`server/src/games/chinesechess/logic/ChineseChessRules.js`

